# Live AR Ballot Appreciation

Real-time ballot appreciation using webcam with augmented reality visualization.

**Phase 2 Complete**: Now uses core OMR modules (`image_aligner`, `mark_detector`, `barcode_decoder`, `utils`).

## üö¶ Quick Start

```bash
# Install dependencies
pip install --upgrade opencv-contrib-python numpy

# Run with actual ballot template (recommended)
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --template storage/app/tests/omr-appreciation/latest/template/coordinates.json \
  --threshold 0.30

# Run with demo grid (for testing without template)
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --demo-grid --size 2480x3508
```

## üéØ Features

### Phase 2 Integration (‚úÖ Complete)
- ‚úÖ Uses `image_aligner.py` for ArUco/AprilTag/black square detection
- ‚úÖ Uses `mark_detector.py` for bubble fill detection
- ‚úÖ Uses `barcode_decoder.py` for QR code document ID extraction
- ‚úÖ Uses `utils.py` for loading `coordinates.json` templates
- ‚úÖ Quality gates (green/amber/red) from alignment
- ‚úÖ Real-time FPS counter
- ‚úÖ Angle detection and display

### AR Overlay
- **Yellow circles**: Fiducial markers (ArUco/AprilTag)
- **Green circles**: Filled bubbles (high confidence)
- **Yellow circles**: Filled bubbles (low confidence)
- **Red circles**: Empty bubbles
- **Top-left info**: Ballot ID, decoder, quality, angle, FPS

## üß™ CLI Reference

```bash
python packages/omr-appreciation/omr-python/appreciate_live.py [options]

Required (choose one):
  --template PATH         Path to coordinates.json template file
  --demo-grid             Use demo grid for testing (no template needed)

Optional:
  --camera N              Camera device index (default: 0)
  --threshold 0.30        Fill detection threshold 0.0-1.0 (default: 0.30)
  --size WxH              Ballot size in pixels (demo mode only, default: 2480x3508)
  --show-warp             Show warped ballot view in separate window
  --no-fps                Hide FPS counter
  --no-barcode            Skip barcode decode (faster, less info)

Keyboard Controls:
  ESC - Exit application
  W   - Toggle warped view (debug)
```

## üìã Examples

### With Real Ballot Template
```bash
# Use template from latest test run
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --template storage/app/tests/omr-appreciation/latest/template/coordinates.json \
  --threshold 0.3

# With warped view for debugging
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --template path/to/coordinates.json \
  --show-warp

# Skip barcode for faster processing
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --template path/to/coordinates.json \
  --no-barcode
```

### Demo Mode (No Template)
```bash
# Standard demo
python packages/omr-appreciation/omr-python/appreciate_live.py --demo-grid

# Custom ballot size
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --demo-grid --size 2000x2800

# Demo with warped view
python packages/omr-appreciation/omr-python/appreciate_live.py \
  --demo-grid --show-warp
```

## üìù Template Format

The system now uses full `coordinates.json` templates generated by the ballot rendering system.

Example structure:
```json
{
  "fiducial": {
    "tl": {"x": 8.5, "y": 8.5, "marker_id": 101, "type": "aruco"},
    "tr": {"x": 173.15, "y": 8.5, "marker_id": 102, "type": "aruco"},
    "br": {"x": 173.15, "y": 260.15, "marker_id": 103, "type": "aruco"},
    "bl": {"x": 8.5, "y": 260.15, "marker_id": 104, "type": "aruco"}
  },
  "bubble": {
    "PRESIDENT_001": {
      "center_x": 45.5,
      "center_y": 80.2,
      "diameter": 6.0
    },
    ...
  },
  "barcode": {
    "document_barcode": {
      "x": 99,
      "y": 254,
      "type": "QRCODE",
      "data": "BALLOT-001-fallback"
    }
  }
}
```

**Note**: All coordinates in millimeters. System converts to pixels at 300 DPI (11.811 px/mm).

## üîß Troubleshooting

### No Fiducials Detected
- **Problem**: Yellow markers not showing
- **Solution**: 
  - Ensure ArUco markers are visible in camera
  - Check lighting (avoid glare/shadows)
  - Verify marker IDs match template (101-104)
  - Try moving ballot closer/farther from camera

### Low FPS
- **Problem**: Frame rate below 15 FPS
- **Solution**:
  - Use `--no-barcode` flag
  - Reduce camera resolution
  - Close other applications
  - Use demo mode for testing

### Bubbles Not Detected
- **Problem**: No colored circles on bubbles
- **Solution**:
  - Ensure fiducials are detected first (yellow circles visible)
  - Check that template matches ballot being scanned
  - Adjust `--threshold` value (try 0.25 or 0.35)
  - Verify bubble coordinates in template

### Barcode Not Detected
- **Problem**: "Decoder: metadata" instead of "Decoder: pyzbar"
- **Solution**:
  - Ensure QR code is visible and not obstructed
  - Check QR code size (minimum 12mm recommended)
  - Verify coordinates in template match actual QR position
  - Try better lighting or sharper camera focus

## üöÄ Next Steps (Phase 3-4)

### Phase 3: Enhanced AR Features
- [ ] Vote accumulator (stability over frames)
- [ ] Audio feedback on mark detection
- [ ] Freeze frame & capture (F/S keys)
- [ ] Multi-contest validation
- [ ] Session management & data persistence

### Phase 4: Laravel Integration
- [ ] Flask streaming server
- [ ] Laravel routes & controllers
- [ ] Web-based viewing
- [ ] Real-time updates via WebSocket

## üìö Related Documentation

- [AR Integration Plan](augmented_reality/AR_INTEGRATION_PLAN.md) - Full integration roadmap
- [Barcode Decoder Guide](BARCODE_DECODER_GUIDE.md) - QR code extraction details
- [OMR Test Plan](simulation/OMR_APPRECIATION_TEST_PLAN_REVISED.md) - Testing strategy

## üÜö Changes from Original

| Feature | Original | Refactored |
|---------|----------|------------|
| Fiducial Detection | Custom ArUco only | Core `image_aligner` (ArUco/AprilTag/black squares) |
| Mark Detection | Simplified logic | Core `mark_detector` (production-grade) |
| Barcode Support | ‚ùå None | ‚úÖ QR/Code128/PDF417 via `barcode_decoder` |
| Quality Gates | ‚ùå None | ‚úÖ Green/Amber/Red quality indicators |
| Template Format | Simple bubbles JSON | Full `coordinates.json` |
| Code Size | 173 lines | 329 lines (+documentation +features) |
| Module Reuse | 0% | 100% (uses all core modules) |

## üí° Tips

- **Print ArUco markers** on corners of your ballot for best results
- **Use good lighting** - avoid glare and shadows
- **Start with demo mode** to verify camera and system work
- **Test with real template** before live voting
- **Monitor FPS** - should stay above 20 for smooth experience
- **Use ESC to exit** cleanly (don't force-quit)
